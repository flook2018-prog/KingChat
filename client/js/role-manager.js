/**
 * Role Manager - Frontend Role-Based Access Control
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ö‡∏ô Frontend ‡∏ï‡∏≤‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
 */

class RoleManager {
    constructor() {
        this.currentUser = null;
        this.permissions = [];
        this.roleLevel = 0;
        this.isInitialized = false;
    }

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ï‡∏≤‡∏°‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó (‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Backend)
    static ROLE_PERMISSIONS = {
        'super_admin': {
            level: 100,
            permissions: [
                'manage_users',
                'manage_system', 
                'manage_chat',
                'manage_lineoa',
                'manage_customers',
                'manage_quick_messages',
                'view_all_data',
                'system_settings',
                'admin_management'
            ]
        },
        'admin': {
            level: 80,
            permissions: [
                'manage_chat',
                'manage_lineoa',
                'manage_customers', 
                'manage_quick_messages',
                'view_customer_data'
            ]
        },
        'moderator': {
            level: 60,
            permissions: [
                'manage_chat',
                'view_customer_data'
            ]
        },
        'user': {
            level: 40,
            permissions: [
                'view_chat',
                'basic_access'
            ]
        }
    };

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
    async initialize() {
        try {
            console.log('üîê Initializing Role Manager...');
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å API
            await this.fetchUserRole();
            
            // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
            this.applyPermissions();
            
            this.isInitialized = true;
            console.log('‚úÖ Role Manager initialized successfully');
            
        } catch (error) {
            console.error('‚ùå Role Manager initialization failed:', error);
            // ‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
            this.setFallbackPermissions();
        }
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å Backend
    async fetchUserRole() {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                throw new Error('No authentication token found');
            }

            const response = await fetch('/api/roles/me', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            if (data.success) {
                this.currentUser = data.user;
                this.permissions = data.user.permissions || [];
                this.roleLevel = data.user.level || 0;
                
                console.log(`üë§ User: ${this.currentUser.username} (${this.currentUser.role})`);
                console.log(`üéØ Permissions:`, this.permissions);
                console.log(`üìä Level: ${this.roleLevel}`);
            } else {
                throw new Error('Failed to fetch user role data');
            }

        } catch (error) {
            console.error('‚ùå Error fetching user role:', error);
            throw error;
        }
    }

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô
    setFallbackPermissions() {
        console.log('‚ö†Ô∏è Using fallback permissions');
        this.currentUser = { 
            username: 'Guest', 
            role: 'user',
            level: 40
        };
        this.permissions = ['basic_access'];
        this.roleLevel = 40;
        this.applyPermissions();
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    hasPermission(permission) {
        return this.permissions.includes(permission);
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
    hasLevel(requiredLevel) {
        return this.roleLevel >= requiredLevel;
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
    hasRole(role) {
        return this.currentUser?.role === role;
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó
    hasAnyRole(roles) {
        return roles.includes(this.currentUser?.role);
    }

    // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
    applyPermissions() {
        console.log('üé≠ Applying role-based permissions to UI...');

        // ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ï‡∏≤‡∏° data-permission
        this.hideElementsByPermission();
        
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ï‡∏≤‡∏° data-role
        this.hideElementsByRole();
        
        // ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ï‡∏≤‡∏° data-level
        this.hideElementsByLevel();

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
        this.updateUIElements();
    }

    // ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ï‡∏≤‡∏° data-permission
    hideElementsByPermission() {
        const elements = document.querySelectorAll('[data-permission]');
        elements.forEach(element => {
            const requiredPermission = element.getAttribute('data-permission');
            if (!this.hasPermission(requiredPermission)) {
                element.style.display = 'none';
                console.log(`üö´ Hidden element requiring permission: ${requiredPermission}`);
            } else {
                element.style.display = '';
                console.log(`‚úÖ Shown element with permission: ${requiredPermission}`);
            }
        });
    }

    // ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ï‡∏≤‡∏° data-role
    hideElementsByRole() {
        const elements = document.querySelectorAll('[data-role]');
        elements.forEach(element => {
            const requiredRoles = element.getAttribute('data-role').split(',').map(r => r.trim());
            if (!this.hasAnyRole(requiredRoles)) {
                element.style.display = 'none';
                console.log(`üö´ Hidden element requiring role: ${requiredRoles.join(', ')}`);
            } else {
                element.style.display = '';
                console.log(`‚úÖ Shown element with role: ${requiredRoles.join(', ')}`);
            }
        });
    }

    // ‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ï‡∏≤‡∏° data-level
    hideElementsByLevel() {
        const elements = document.querySelectorAll('[data-level]');
        elements.forEach(element => {
            const requiredLevel = parseInt(element.getAttribute('data-level'));
            if (!this.hasLevel(requiredLevel)) {
                element.style.display = 'none';
                console.log(`üö´ Hidden element requiring level: ${requiredLevel}`);
            } else {
                element.style.display = '';
                console.log(`‚úÖ Shown element with level: ${requiredLevel}`);
            }
        });
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI elements ‡πÄ‡∏â‡∏û‡∏≤‡∏∞
    updateUIElements() {
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô navbar
        this.updateUserInfo();
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏ô‡∏π
        this.updateNavigationMenu();
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô
        this.updateActionButtons();
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    updateUserInfo() {
        const userNameElement = document.getElementById('userName');
        const userRoleElement = document.getElementById('userRole');
        
        if (userNameElement && this.currentUser) {
            userNameElement.textContent = this.currentUser.username;
        }
        
        if (userRoleElement && this.currentUser) {
            userRoleElement.textContent = this.getRoleDisplayName(this.currentUser.role);
        }
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏≥‡∏ó‡∏≤‡∏á
    updateNavigationMenu() {
        // ‡∏ã‡πà‡∏≠‡∏ô/‡πÅ‡∏™‡∏î‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏°‡∏ô‡∏π‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
        const menuItems = document.querySelectorAll('.menu-item');
        menuItems.forEach(item => {
            const page = item.getAttribute('data-page');
            if (page && !this.canAccessPage(page)) {
                item.style.display = 'none';
            }
        });
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
    updateActionButtons() {
        // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
        const buttons = document.querySelectorAll('[data-action]');
        buttons.forEach(button => {
            const action = button.getAttribute('data-action');
            if (!this.canPerformAction(action)) {
                button.disabled = true;
                button.title = '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ';
            }
        });
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    canAccessPage(page) {
        const pagePermissions = {
            'admin': ['admin_management'],
            'settings': ['system_settings'],
            'quick-messages': ['manage_quick_messages'],
            'customers': ['manage_customers', 'view_customer_data'],
            'chat': ['manage_chat', 'view_chat'],
            'accounts': ['manage_lineoa']
        };

        const requiredPermissions = pagePermissions[page];
        if (!requiredPermissions) return true; // ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏û‡∏¥‡πÄ‡∏®‡∏©

        return requiredPermissions.some(permission => this.hasPermission(permission));
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    canPerformAction(action) {
        const actionPermissions = {
            'create-user': ['manage_users'],
            'delete-user': ['manage_users'],
            'edit-customer': ['manage_customers'],
            'send-message': ['manage_chat'],
            'manage-lineoa': ['manage_lineoa'],
            'system-config': ['system_settings']
        };

        const requiredPermissions = actionPermissions[action];
        if (!requiredPermissions) return true;

        return requiredPermissions.some(permission => this.hasPermission(permission));
    }

    // ‡πÅ‡∏õ‡∏•‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
    getRoleDisplayName(role) {
        const roleNames = {
            'super_admin': '‡∏ã‡∏∏‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô',
            'admin': '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô',
            'moderator': '‡πÇ‡∏°‡πÄ‡∏î‡∏≠‡πÄ‡∏£‡πÄ‡∏ï‡∏≠‡∏£‡πå',
            'user': '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'
        };
        return roleNames[role] || role;
    }

    // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á)
    async refresh() {
        console.log('üîÑ Refreshing role permissions...');
        await this.initialize();
    }

    // ‡∏î‡∏µ‡∏ö‡∏±‡∏Å - ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    debug() {
        console.log('üîç Role Manager Debug Info:');
        console.log('Current User:', this.currentUser);
        console.log('Permissions:', this.permissions);
        console.log('Role Level:', this.roleLevel);
        console.log('Is Initialized:', this.isInitialized);
    }
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á instance ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
window.roleManager = new RoleManager();

// Auto-initialize ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
document.addEventListener('DOMContentLoaded', () => {
    // ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ initialize ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ token ‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß
    setTimeout(() => {
        window.roleManager.initialize();
    }, 500);
});

// Export ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô modules ‡∏≠‡∏∑‡πà‡∏ô
if (typeof module !== 'undefined' && module.exports) {
    module.exports = RoleManager;
}