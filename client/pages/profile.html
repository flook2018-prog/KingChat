<!DOCTY    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/loading.css">
    <link rel="stylesheet" href="../css/mobile.css">
    <link rel="stylesheet" href="../css/line-theme.css">
    <link rel="stylesheet" href="../css/brand-animation.css">
    <link rel="stylesheet" href="../css/responsive-ux.css">
    <style>
        /* ‡∏¢‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î navbar */
        .main-content {
            padding-top: var(--space-4) !important;
            max-height: calc(100vh - var(--navbar-height)) !important;
            overflow-y: auto !important;
            display: flex !important;
            flex-direction: column !important;
        }
        
        .page-header {
            margin-top: 0 !important;
            padding-top: 0 !important;
            margin-bottom: var(--space-4) !important;
            flex-shrink: 0 !important;
        }
        
        .page-content {
            flex: 1 !important;
            overflow-y: auto !important;
            padding-bottom: var(--space-4) !important;
        }
        
        .profile-form-container {
            max-height: calc(100vh - 200px) !important;
            overflow-y: auto !important;
        }
    </style>tml>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå - KingChat</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/loading.css">
    <link rel="stylesheet" href="../css/mobile.css">
    <link rel="stylesheet" href="../css/line-theme.css">
    <style>
        .profile-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .profile-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 20px;
            border: 4px solid rgba(255,255,255,0.3);
        }

        .profile-form {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .password-group {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .profile-container {
                padding: 10px;
            }
            
            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <span class="crown">üëë</span>
            <span class="brand-text">KingChat</span>
        </div>
        <div class="navbar-menu">
            <div class="navbar-item">
                <button class="theme-toggle" id="themeToggle" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏µ">
                    <span id="themeIcon">üåô</span>
                </button>
            </div>
            <div class="navbar-item">
                <span id="navUserName">System Administrator</span>
            </div>
            <div class="dropdown navbar-item">
                <button class="btn btn-ghost dropdown-toggle" id="userMenu">
                    üë§
                </button>
                <div class="dropdown-menu" id="userDropdown">
                    <a href="profile.html" class="dropdown-item">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a>
                    <a href="settings.html" class="dropdown-item">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</a>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-menu">
            <a href="../dashboard.html" class="menu-item">
                <span class="menu-icon">üè†</span>
                <span class="menu-text">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
            </a>
            <a href="lineoa.html" class="menu-item">
                <span class="menu-icon">ÔøΩ</span>
                <span class="menu-text">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ LINE OA</span>
            </a>
            <a href="customers.html" class="menu-item">
                <span class="menu-icon">üë•</span>
                <span class="menu-text">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
            </a>
            <a href="chat.html" class="menu-item">
                <span class="menu-icon">üí≠</span>
                <span class="menu-text">‡πÅ‡∏ä‡∏ó</span>
            </a>
            <a href="admin-management.html" class="menu-item">
                <span class="menu-icon">‚öôÔ∏è</span>
                <span class="menu-text">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</span>
            </a>
            <a href="profile.html" class="menu-item active">
                <span class="menu-icon">üë§</span>
                <span class="menu-text">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span>
            </a>
            <a href="settings.html" class="menu-item">
                <span class="menu-icon">üîß</span>
                <span class="menu-text">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="profile-container">
                <div class="profile-header">
                    <div class="profile-avatar">üë§</div>
                    <h1 id="userDisplayName">System Administrator</h1>
                    <p id="userRole">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
                </div>

                <div id="alertContainer"></div>

                <form class="profile-form" id="profileForm">
                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß -->
                    <div class="form-section">
                        <div class="section-title">
                            <span>üë§</span>
                            <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</span>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="displayName">‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á</label>
                                <input type="text" id="displayName" name="displayName" required>
                            </div>
                            <div class="form-group">
                                <label for="username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                                <input type="text" id="username" name="username" required readonly>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
                                <input type="email" id="email" name="email">
                            </div>
                            <div class="form-group">
                                <label for="phone">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                                <input type="tel" id="phone" name="phone">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="role">‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</label>
                            <select id="role" name="role" disabled>
                                <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</option>
                                <option value="agent">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</option>
                                <option value="viewer">‡∏ú‡∏π‡πâ‡∏î‡∏π</option>
                            </select>
                        </div>
                    </div>

                    <!-- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô -->
                    <div class="form-section">
                        <div class="section-title">
                            <span>üîê</span>
                            <span>‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</span>
                        </div>

                        <div class="form-group">
                            <label for="currentPassword">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                            <div class="password-group">
                                <input type="password" id="currentPassword" name="currentPassword">
                                <button type="button" class="password-toggle" onclick="togglePassword('currentPassword')">üëÅÔ∏è</button>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="newPassword">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                                <div class="password-group">
                                    <input type="password" id="newPassword" name="newPassword">
                                    <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">üëÅÔ∏è</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="confirmPassword">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
                                <div class="password-group">
                                    <input type="password" id="confirmPassword" name="confirmPassword">
                                    <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">üëÅÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -->
                    <div class="form-section">
                        <div class="section-title">
                            <span>üìù</span>
                            <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
                        </div>

                        <div class="form-group">
                            <label for="bio">‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏â‡∏±‡∏ô</label>
                            <textarea id="bio" name="bio" placeholder="‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á..."></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="department">‡πÅ‡∏ú‡∏ô‡∏Å</label>
                                <input type="text" id="department" name="department">
                            </div>
                            <div class="form-group">
                                <label for="position">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
                                <input type="text" id="position" name="position">
                            </div>
                        </div>
                    </div>

                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/theme.js"></script>
    <script>
        let originalData = {};
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            if (!auth.isLoggedIn()) {
                window.location.href = '../login.html';
                return;
            }

            await loadUserProfile();
        });

        // Load user profile data
        async function loadUserProfile() {
            try {
                const user = auth.getUser();
                if (!user) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                }

                // Get detailed user info from API
                const userDetail = await api.getUserById(user.id);
                
                // Store original data for reset
                originalData = { ...userDetail };

                // Populate form
                document.getElementById('displayName').value = userDetail.displayName || '';
                document.getElementById('username').value = userDetail.username || '';
                document.getElementById('email').value = userDetail.email || '';
                document.getElementById('phone').value = userDetail.phone || '';
                document.getElementById('role').value = userDetail.role || 'agent';
                document.getElementById('bio').value = userDetail.bio || '';
                document.getElementById('department').value = userDetail.department || '';
                document.getElementById('position').value = userDetail.position || '';

                // Update header
                document.getElementById('userDisplayName').textContent = userDetail.displayName || userDetail.username;
                document.getElementById('userRole').textContent = getRoleDisplayName(userDetail.role);

                // Update navbar
                document.getElementById('navUserName').textContent = userDetail.displayName || userDetail.username;

            } catch (error) {
                console.error('Error loading profile:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå', 'danger');
            }
        }

        // Handle form submission
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const formData = new FormData(e.target);
                const updateData = {};
                
                // Basic profile data
                updateData.displayName = formData.get('displayName');
                updateData.email = formData.get('email');
                updateData.phone = formData.get('phone');
                updateData.bio = formData.get('bio');
                updateData.department = formData.get('department');
                updateData.position = formData.get('position');

                // Password change
                const currentPassword = formData.get('currentPassword');
                const newPassword = formData.get('newPassword');
                const confirmPassword = formData.get('confirmPassword');

                if (newPassword) {
                    if (!currentPassword) {
                        throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô');
                    }
                    if (newPassword !== confirmPassword) {
                        throw new Error('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
                    }
                    if (newPassword.length < 6) {
                        throw new Error('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                    }
                    
                    updateData.currentPassword = currentPassword;
                    updateData.newPassword = newPassword;
                }

                // Update profile
                const user = auth.getUser();
                await api.updateUser(user.id, updateData);

                // Update stored user data if display name changed
                if (updateData.displayName !== originalData.displayName) {
                    const updatedUser = { ...user, displayName: updateData.displayName };
                    auth.setUser(updatedUser);
                }

                // Clear password fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';

                showAlert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                
                // Reload profile data
                await loadUserProfile();

            } catch (error) {
                console.error('Error updating profile:', error);
                showAlert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'danger');
            }
        });

        // Reset form to original data
        function resetForm() {
            document.getElementById('displayName').value = originalData.displayName || '';
            document.getElementById('email').value = originalData.email || '';
            document.getElementById('phone').value = originalData.phone || '';
            document.getElementById('bio').value = originalData.bio || '';
            document.getElementById('department').value = originalData.department || '';
            document.getElementById('position').value = originalData.position || '';
            
            // Clear password fields
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        // Toggle password visibility
        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.nextElementSibling;
            
            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = 'üôà';
            } else {
                field.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }

        // Show alert message
        function showAlert(message, type) {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `
                <div class="alert alert-${type}">
                    ${message}
                </div>
            `;
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }

        // Get role display name
        function getRoleDisplayName(role) {
            const roleNames = {
                admin: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
                agent: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà',
                viewer: '‡∏ú‡∏π‡πâ‡∏î‡∏π'
            };
            return roleNames[role] || role;
        }

        // Dropdown functionality
        document.getElementById('userMenu').addEventListener('click', toggleDropdown);
        
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            handleLogout();
        });

        function toggleDropdown() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.dropdown')) {
                const dropdown = document.getElementById('userDropdown');
                dropdown.classList.remove('show');
            }
        });

        // Handle logout
        function handleLogout() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                auth.logout();
                window.location.href = '../login.html';
            }
        }
    </script>
    
    <script src="../js/brand-animation.js"></script>
    <script src="../js/user-display.js"></script>
    <script src="../js/global-user-menu.js"></script>
</body>
</html>