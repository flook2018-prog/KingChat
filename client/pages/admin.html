<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô - KingChat</title>
    <script>
        // Redirect to new admin management page
        window.location.href = 'admin-management.html';
    </script>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/loading.css">
    <link rel="stylesheet" href="../css/mobile.css">
    <link rel="stylesheet" href="../css/line-theme.css">
    <link rel="stylesheet" href="../css/brand-animation.css">
    <link rel="stylesheet" href="../css/responsive-ux.css">
    <style>
        .main-content {
            padding-top: var(--space-4) !important;
            max-height: calc(100vh - var(--navbar-height)) !important;
            overflow-y: auto !important;
            display: flex !important;
            flex-direction: column !important;
        }
        
        .page-header {
            margin-top: 0 !important;
            padding-top: 0 !important;
            margin-bottom: var(--space-4) !important;
            flex-shrink: 0 !important;
        }
        
        .admin-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        
        .btn-icon {
            padding: 6px 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
        }
        
        .btn-view { background: #06b5d4; color: white; }
        .btn-view:hover { background: #0589a3; }
        .btn-edit { background: #f59e0b; color: white; }
        .btn-edit:hover { background: #d97706; }
        .btn-delete { background: #ef4444; color: white; }
        .btn-delete:hover { background: #dc2626; }
        .btn-password { background: #8b5cf6; color: white; }
        .btn-password:hover { background: #7c3aed; }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-online { background: #dcfce7; color: #166534; }
        .status-offline { background: #fecaca; color: #991b1b; }
        
        .data-source {
            background: #f3f4f6;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 16px;
        }
        
        .data-source.mongodb { background: #dcfce7; color: #166534; }
        .data-source.error { background: #fecaca; color: #991b1b; }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #00c73c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .modal-close {
            background: #f3f4f6;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #6b7280;
        }
        
        .modal-close:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: #374151;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #00c73c;
            box-shadow: 0 0 0 3px rgba(0, 199, 60, 0.1);
        }
        
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-cancel {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .btn-cancel:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        .btn-primary {
            background: #00c73c;
            color: white;
        }
        
        .btn-primary:hover {
            background: #16a34a;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <span class="crown">üëë</span>
            <span class="brand-text">KingChat</span>
        </div>
        <div class="navbar-menu">
            <div class="navbar-item">
                <button class="theme-toggle" id="themeToggle" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏µ">
                    <span id="themeIcon">üåô</span>
                </button>
            </div>
            <div class="navbar-item">
                <span>System Administrator</span>
            </div>
            <div class="dropdown navbar-item">
                <button class="btn btn-ghost dropdown-toggle" id="userMenu">‚öô</button>
                <div class="dropdown-menu" id="userDropdown">
                    <a href="../profile.html" class="dropdown-item">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a>
                    <a href="../settings.html" class="dropdown-item">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</a>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-menu">
            <a href="../dashboard.html" class="menu-item">
                <span class="menu-icon">üè†</span>
                <span class="menu-text">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
            </a>
            <a href="lineoa.html" class="menu-item">
                <span class="menu-icon">üì±</span>
                <span class="menu-text">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ LINE OA</span>
            </a>
            <a href="customers.html" class="menu-item">
                <span class="menu-icon">üë•</span>
                <span class="menu-text">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
            </a>
            <a href="chat.html" class="menu-item">
                <span class="menu-icon">üí¨</span>
                <span class="menu-text">‡πÅ‡∏ä‡∏ó</span>
            </a>
            <a href="admin.html" class="menu-item active">
                <span class="menu-icon">‚öôÔ∏è</span>
                <span class="menu-text">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</span>
            </a>
            <a href="settings.html" class="menu-item">
                <span class="menu-icon">üîß</span>
                <span class="menu-text">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h1>
            <p class="page-subtitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á - ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MongoDB</p>
        </div>

        <div class="page-content">
            <!-- Controls -->
            <div class="content-card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h3 class="card-title">üõ†Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</h3>
                    <button class="btn btn-primary" onclick="showAddAdminModal()">
                        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
            </div>

            <!-- Admin List -->
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3>
                    <div class="card-actions">
                        <button class="btn btn-secondary" onclick="loadAdmins()">
                            üîÑ ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                        <button class="btn btn-info" onclick="testMongoDB()">
                            üîç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö MongoDB
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <!-- Status -->
                    <div id="dataSourceIndicator" class="data-source">
                        <span class="loading-spinner"></span>
                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å MongoDB...
                    </div>
                    
                    <!-- Table -->
                    <div style="overflow-x: auto;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</th>
                                    <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠</th>
                                    <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="adminTableBody">
                                <tr>
                                    <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Admin Modal -->
    <div class="modal" id="addAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</h2>
                <button class="modal-close" onclick="hideAddAdminModal()">‚úï</button>
            </div>
            <form id="addAdminForm" onsubmit="handleAddAdmin(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)</label>
                        <input type="text" class="form-input" name="username" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á (Display Name)</label>
                        <input type="text" class="form-input" name="displayName" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)</label>
                        <input type="password" class="form-input" name="password" required placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Role)</label>
                        <select class="form-select" name="role" required>
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå --</option>
                            <option value="super_admin">Super Admin</option>
                            <option value="admin">Admin</option>
                            <option value="moderator">Moderator</option>
                            <option value="user">User</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-cancel" onclick="hideAddAdminModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Admin Modal -->
    <div class="modal" id="editAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h2>
                <button class="modal-close" onclick="hideEditAdminModal()">‚úï</button>
            </div>
            <form id="editAdminForm" onsubmit="handleEditAdmin(event)">
                <div class="modal-body">
                    <input type="hidden" name="adminId" id="editAdminId">
                    <div class="form-group">
                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)</label>
                        <input type="text" class="form-input" name="username" id="editUsername" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á (Display Name)</label>
                        <input type="text" class="form-input" name="displayName" id="editDisplayName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</label>
                        <input type="password" class="form-input" name="password" id="editPassword" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Role)</label>
                        <select class="form-select" name="role" id="editRole" required>
                            <option value="super_admin">Super Admin</option>
                            <option value="admin">Admin</option>
                            <option value="moderator">Moderator</option>
                            <option value="user">User</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                        <select class="form-select" name="status" id="editStatus">
                            <option value="offline">Offline</option>
                            <option value="online">Online</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-cancel" onclick="hideEditAdminModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteAdminModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">üóëÔ∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h2>
                <button class="modal-close" onclick="hideDeleteAdminModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <p>‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô <strong id="deleteAdminName"></strong> ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                <p style="color: #ef4444; font-weight: 600;">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ</p>
                <input type="hidden" id="deleteAdminId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" onclick="hideDeleteAdminModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteAdmin()">‡∏•‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ Global
        let currentAdmins = [];
        
        // MongoDB API Functions
        const API_BASE = 'http://localhost:5001/api';
        
        // Utility Functions
        function updateStatus(message, type = 'info') {
            const indicator = document.getElementById('dataSourceIndicator');
            if (indicator) {
                indicator.className = `data-source ${type}`;
                indicator.innerHTML = type === 'loading' ? 
                    `<span class="loading-spinner"></span>${message}` : 
                    message;
            }
        }
        
        function getRoleDisplayName(role) {
            const roleNames = {
                'super_admin': 'Super Admin',
                'admin': 'Admin',
                'moderator': 'Moderator',
                'user': 'User'
            };
            return roleNames[role] || role;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            return new Date(dateString).toLocaleDateString('th-TH');
        }
        
        // Load Admins from MongoDB
        async function loadAdmins() {
            try {
                updateStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å MongoDB...', 'loading');
                
                const response = await fetch(`${API_BASE}/admin/admin-users`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ MongoDB Response:', data);
                
                currentAdmins = data.users || [];
                updateStatus(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å MongoDB ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ${currentAdmins.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'mongodb');
                renderAdminTable();
                
            } catch (error) {
                console.error('‚ùå Error loading admins:', error);
                updateStatus(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
                currentAdmins = [];
                renderAdminTable();
            }
        }
        
        // Render Admin Table
        function renderAdminTable() {
            const tbody = document.getElementById('adminTableBody');
            
            if (currentAdmins.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                            üì≠ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = currentAdmins.map(admin => {
                const adminId = admin.id || admin._id;
                const createdDate = formatDate(admin.createdAt);
                const statusClass = admin.status === 'online' ? 'status-online' : 'status-offline';
                const statusText = admin.status === 'online' ? '‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå' : '‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå';
                
                return `
                    <tr>
                        <td style="font-family: monospace; font-size: 12px; color: #666;">
                            ${adminId}
                        </td>
                        <td>
                            <div style="font-weight: 600; color: #2c3e50;">${admin.displayName || admin.username}</div>
                            <div style="font-size: 14px; color: #7f8c8d;">@${admin.username}</div>
                        </td>
                        <td>
                            <span class="badge badge-${admin.role}">${getRoleDisplayName(admin.role)}</span>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </td>
                        <td style="font-size: 14px; color: #666;">
                            ${createdDate}
                        </td>
                        <td>
                            <div class="admin-actions">
                                <button class="btn-icon btn-edit" onclick="editAdmin('${adminId}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                                <button class="btn-icon btn-password" onclick="showPassword('${adminId}')" title="‡∏î‡∏π‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">üîê</button>
                                <button class="btn-icon btn-delete" onclick="deleteAdmin('${adminId}')" title="‡∏•‡∏ö">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Add Admin
        async function handleAddAdmin(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const adminData = {
                username: formData.get('username').trim(),
                displayName: formData.get('displayName').trim(),
                password: formData.get('password').trim(),
                role: formData.get('role')
            };
            
            // Validation
            if (!adminData.username || !adminData.displayName || !adminData.password || !adminData.role) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                return;
            }
            
            if (adminData.password.length < 6) {
                alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin-users/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(adminData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText);
                }
                
                const result = await response.json();
                console.log('‚úÖ Admin created:', result);
                
                alert(`‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô "${adminData.displayName}" ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                hideAddAdminModal();
                loadAdmins(); // Reload data
                
            } catch (error) {
                console.error('‚ùå Error creating admin:', error);
                alert(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
            }
        }
        
        // Edit Admin
        function editAdmin(adminId) {
            const admin = currentAdmins.find(a => (a.id || a._id) === adminId);
            if (!admin) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô');
                return;
            }
            
            document.getElementById('editAdminId').value = adminId;
            document.getElementById('editUsername').value = admin.username;
            document.getElementById('editDisplayName').value = admin.displayName;
            document.getElementById('editPassword').value = '';
            document.getElementById('editRole').value = admin.role;
            document.getElementById('editStatus').value = admin.status || 'offline';
            
            showEditAdminModal();
        }
        
        async function handleEditAdmin(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const adminId = formData.get('adminId');
            const adminData = {
                username: formData.get('username').trim(),
                displayName: formData.get('displayName').trim(),
                role: formData.get('role'),
                status: formData.get('status')
            };
            
            // Only include password if provided
            const password = formData.get('password').trim();
            if (password) {
                adminData.password = password;
            }
            
            try {
                // Update via bulk update (reload all and update one)
                const currentAdmin = currentAdmins.find(a => (a.id || a._id) === adminId);
                if (currentAdmin) {
                    Object.assign(currentAdmin, adminData);
                    
                    const response = await fetch(`${API_BASE}/admin/admin-users`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            users: currentAdmins, 
                            timestamp: new Date().toISOString() 
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to update admin');
                    }
                    
                    alert('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    hideEditAdminModal();
                    loadAdmins(); // Reload data
                }
                
            } catch (error) {
                console.error('‚ùå Error updating admin:', error);
                alert(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
            }
        }
        
        // Delete Admin
        function deleteAdmin(adminId) {
            const admin = currentAdmins.find(a => (a.id || a._id) === adminId);
            if (!admin) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô');
                return;
            }
            
            document.getElementById('deleteAdminId').value = adminId;
            document.getElementById('deleteAdminName').textContent = admin.displayName || admin.username;
            showDeleteAdminModal();
        }
        
        async function confirmDeleteAdmin() {
            const adminId = document.getElementById('deleteAdminId').value;
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin-users/${adminId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to delete admin');
                }
                
                alert('‚úÖ ‡∏•‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                hideDeleteAdminModal();
                loadAdmins(); // Reload data
                
            } catch (error) {
                console.error('‚ùå Error deleting admin:', error);
                alert(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
            }
        }
        
        // Show Password
        function showPassword(adminId) {
            const admin = currentAdmins.find(a => (a.id || a._id) === adminId);
            if (!admin) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô');
                return;
            }
            
            const confirmed = confirm(`‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á ${admin.displayName}:\n\n${admin.password}\n\n‡∏Ñ‡∏•‡∏¥‡∏Å OK ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î`);
            if (confirmed) {
                navigator.clipboard.writeText(admin.password).then(() => {
                    alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏•‡πâ‡∏ß');
                }).catch(() => {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á');
                });
            }
        }
        
        // Modal Functions
        function showAddAdminModal() {
            document.getElementById('addAdminModal').style.display = 'flex';
        }
        
        function hideAddAdminModal() {
            document.getElementById('addAdminModal').style.display = 'none';
            document.getElementById('addAdminForm').reset();
        }
        
        function showEditAdminModal() {
            document.getElementById('editAdminModal').style.display = 'flex';
        }
        
        function hideEditAdminModal() {
            document.getElementById('editAdminModal').style.display = 'none';
        }
        
        function showDeleteAdminModal() {
            document.getElementById('deleteAdminModal').style.display = 'flex';
        }
        
        function hideDeleteAdminModal() {
            document.getElementById('deleteAdminModal').style.display = 'none';
        }
        
        // Test MongoDB Connection
        async function testMongoDB() {
            try {
                updateStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MongoDB...', 'loading');
                
                const response = await fetch(`${API_BASE}/admin/admin-users`);
                const data = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MongoDB ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n‡∏û‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô: ${data.users.length} ‡∏Ñ‡∏ô\n‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${data.source}`);
                    updateStatus(`‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MongoDB ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ${data.users.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`, 'mongodb');
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
                
            } catch (error) {
                alert(`‚ùå ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MongoDB ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`);
                updateStatus(`‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ MongoDB ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, 'error');
            }
        }
        
        // Create Sample Admin User
        async function createSampleAdmin() {
            const sampleAdmin = {
                username: 'kingadmin',
                displayName: 'King Administrator',
                password: 'king123456',
                role: 'super_admin'
            };
            
            try {
                const response = await fetch(`${API_BASE}/admin/admin-users/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(sampleAdmin)
                });
                
                if (response.ok) {
                    console.log('‚úÖ Sample admin created successfully');
                    loadAdmins();
                } else {
                    console.log('‚ÑπÔ∏è Sample admin might already exist');
                }
            } catch (error) {
                console.log('‚ÑπÔ∏è Could not create sample admin:', error.message);
            }
        }
        
        // Logout
        function logout() {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                localStorage.clear();
                window.location.href = '../login.html';
            }
        }
        
        // Initialize Page
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Admin page loaded with clean MongoDB integration');
            
            // Create sample admin user
            await createSampleAdmin();
            
            // Load initial data
            await loadAdmins();
            
            console.log('‚úÖ Page initialization completed');
        });
        
        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const modals = ['addAdminModal', 'editAdminModal', 'deleteAdminModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>

    <!-- Add required JavaScript files -->
    <script src="../js/auth.js"></script>
    <script src="../js/user-display.js"></script>
    <script src="../js/global-user-menu.js"></script>
    <script>
        // Force create user menu and update display after all scripts loaded
        setTimeout(() => {
            if (window.auth && window.auth.isAuthenticated()) {
                console.log('Manually updating user display...');
                if (window.updateUserDisplay) window.updateUserDisplay();
                if (window.forceCreateUserMenu) window.forceCreateUserMenu();
            }
        }, 1000);
    </script>
</body>
</html>