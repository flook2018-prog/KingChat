<!DOCTY    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/loading.css">
    <link rel="stylesheet"                                                                             <h3 class="card-title">‚óè ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3>       <div class="stat-icon">‚óè</div>            <div class="stat-icon">‚óè</div> <div class="stat-icon">‚óè</div>    <h3 class="card-title">üîß ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3>
                <button class="btn btn-primary" id="addAdminBtn">
                    + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà
                </button>="../css/mobile.css">
    <link rel="stylesheet" href="../css/line-theme.css">
    <link rel="stylesheet" href="../css/brand-animation.css">
    <link rel="stylesheet" href="../css/responsive-ux.css">
    <style>
        /* ‡∏¢‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î navbar */
        .main-content {
            padding-top: var(--space-4) !important;
            max-height: calc(100vh - var(--navbar-height)) !important;
            overflow-y: auto !important;
            display: flex !important;
            flex-direction: column !important;
        }
        
        .page-header {
            margin-top: 0 !important;
            padding-top: 0 !important;
            margin-bottom: var(--space-4) !important;
            flex-shrink: 0 !important;
        }
        
        .page-content {
            flex: 1 !important;
            overflow-y: auto !important;
            padding-bottom: var(--space-4) !important;
        }
        
        .users-table-container {
            max-height: calc(100vh - 200px) !important;
            overflow-y: auto !important;
        }
        
        /* Checkbox Group Styling */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-2);
            margin-top: var(--space-2);
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .checkbox-group label:hover {
            background: var(--bg-secondary);
        }
        
        .checkbox-group input[type="checkbox"] {
            margin: 0;
        }
    </style>tml>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô - KingChat</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="stylesheet" href="../css/loading.css">
    <link rel="stylesheet" href="../css/mobile.css">
    <link rel="stylesheet" href="../css/line-theme.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <span class="crown">üëë</span>
            <span class="brand-text">KingChat</span>
        </div>
        <div class="navbar-menu">
            <div class="navbar-item">
                <button class="theme-toggle" id="themeToggle" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏µ">
                    <span id="themeIcon">üåô</span>
                </button>
            </div>
            <div class="navbar-item">
                <span>System Administrator</span>
            </div>
            <div class="dropdown navbar-item">
                <button class="btn btn-ghost dropdown-toggle" id="userMenu">
                    üë§
                </button>
                <div class="dropdown-menu" id="userDropdown">
                    <a href="#" class="dropdown-item">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</a>
                    <a href="#" class="dropdown-item">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</a>
                    <div class="dropdown-divider"></div>
                    <button class="dropdown-item" id="logoutBtn">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-menu">
            <a href="../dashboard.html" class="menu-item">
                <span class="menu-icon">üè†</span>
                <span class="menu-text">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
            </a>
            <a href="lineoa.html" class="menu-item">
                <span class="menu-icon">üì±</span>
                <span class="menu-text">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ LINE OA</span>
            </a>
            <a href="customers.html" class="menu-item">
                <span class="menu-icon">üë•</span>
                <span class="menu-text">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
            </a>
            <a href="chat.html" class="menu-item">
                <span class="menu-icon">üí¨</span>
                <span class="menu-text">‡πÅ‡∏ä‡∏ó</span>
            </a>
            <a href="admin.html" class="menu-item active">
                <span class="menu-icon">üîß</span>
                <span class="menu-text">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</span>
            </a>
            <a href="settings.html" class="menu-item">
                <span class="menu-icon">üîß</span>
                <span class="menu-text">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h1>
            <p class="page-subtitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</p>
        </div>

        <!-- Admin Management Controls -->
        <div class="content-card" style="margin-bottom: var(--space-6);">
            <div class="card-header">
                <h3 class="card-title">üë®‚ÄçÔøΩ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3>
                <button class="btn btn-primary" id="addAdminBtn">
                    ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
            <div class="card-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ÔøΩ‚Äçüíº</div>
                        <div class="stat-content">
                            <div class="stat-number" id="totalAdmins">0</div>
                            <div class="stat-label">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                        </div>
                        <div class="stat-trend positive">
                            <span>+1</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">‚óè</div>
                        <div class="stat-content">
                            <div class="stat-number" id="activeAdmins">0</div>
                            <div class="stat-label">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</div>
                        </div>
                        <div class="stat-trend positive">
                            <span>+1</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">ÔøΩ</div>
                        <div class="stat-content">
                            <div class="stat-number" id="superAdmins">0</div>
                            <div class="stat-label">Super Admin</div>
                        </div>
                        <div class="stat-trend neutral">
                            <span>-</span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">ÔøΩ</div>
                        <div class="stat-content">
                            <div class="stat-number" id="moderators">0</div>
                            <div class="stat-label">Moderator</div>
                        </div>
                        <div class="stat-trend positive">
                            <span>+2</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin List -->
        <div class="content-card">
            <div class="card-header">
                <h3 class="card-title">ÔøΩ‚Äçüíº ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3>
                <div class="card-actions">
                    <input type="text" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô..." id="searchAdmin" style="width: 200px;">
                    <select class="form-control" id="filterAdminRole" style="width: 150px;">
                        <option value="">‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö</option>
                        <option value="super_admin">Super Admin</option>
                        <option value="admin">Admin</option>
                        <option value="moderator">Moderator</option>
                    </select>
                </div>
            </div>
            <div class="card-content">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</th>
                                <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                                <th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="adminTableBody">
                            <tr>
                                <td colspan="5" class="text-center">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Admin Modal -->
    <div class="modal" id="addAdminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                <button class="modal-close" id="closeAddAdminModal">&times;</button>
            </div>
            <form id="addAdminForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="newAdminUsername">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                        <input type="text" id="newAdminUsername" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="newAdminDisplayName">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á</label>
                        <input type="text" id="newAdminDisplayName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="newAdminPassword">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                        <input type="password" id="newAdminPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="newAdminRole">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</label>
                        <select id="newAdminRole" class="form-control" required>
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</option>
                            <option value="super_admin">Super Admin</option>
                            <option value="admin">Admin</option>
                            <option value="moderator">Moderator</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newAdminPermissions">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" id="permManageUsers" value="manage_users"> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                            <label><input type="checkbox" id="permManageChat" value="manage_chat"> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏ó</label>
                            <label><input type="checkbox" id="permManageLineOA" value="manage_lineoa"> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ LINE OA</label>
                            <label><input type="checkbox" id="permViewReports" value="view_reports"> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
                            <label><input type="checkbox" id="permSystemSettings" value="system_settings"> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelAddAdmin">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-primary">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script>
        // Wait for DOM to be loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded fired');
            try {
                // Check if auth is properly loaded
                if (typeof auth === 'undefined' || !auth) {
                    console.warn('Auth module not loaded');
                    window.location.href = '../login.html';
                    return;
                }

                // Check authentication
                if (typeof auth.getToken === 'function' && !auth.getToken()) {
                    window.location.href = '../login.html';
                    return;
                }

                // Check admin role
                if (typeof auth.getUser === 'function') {
                    const currentUser = auth.getUser();
                    if (currentUser && currentUser.role !== 'admin' && currentUser.role !== 'super_admin') {
                        alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ');
                        window.location.href = '../dashboard.html';
                        return;
                    }
                }

                // Debug: Check if AdminManager is loaded
                console.log('AdminManager type:', typeof AdminManager);
                console.log('AdminManager available:', typeof AdminManager !== 'undefined');

                // Initialize admin manager
                if (typeof AdminManager !== 'undefined') {
                    console.log('Initializing AdminManager...');
                    window.adminManager = new AdminManager();
                    console.log('AdminManager initialized:', window.adminManager);
                } else {
                    console.warn('AdminManager not loaded, using fallback modal handling');
                    initializeModals();
                }

                // Load users data
                loadUsers();

                // Show admin menu
                const adminMenus = document.querySelectorAll('.admin-only');
                adminMenus.forEach(menu => {
                    if (menu.style) {
                        menu.style.display = 'flex';
                    }
                });
            } catch (error) {
                console.error('Admin page initialization error:', error);
                window.location.href = '../login.html';
            }
        });

        function initializeModals() {
            console.log('Initializing modal fallback...');
            // Modal functionality
            const addAdminModal = document.getElementById('addAdminModal');
            const addAdminBtn = document.getElementById('addAdminBtn');
            const closeAddAdminModal = document.getElementById('closeAddAdminModal');
            const cancelAddAdmin = document.getElementById('cancelAddAdmin');

            console.log('Modal elements found:', {
                modal: !!addAdminModal,
                button: !!addAdminBtn,
                close: !!closeAddAdminModal,
                cancel: !!cancelAddAdmin
            });

            if (addAdminBtn && addAdminModal) {
                console.log('Adding click event to addAdminBtn');
                addAdminBtn.addEventListener('click', () => {
                    console.log('Add admin button clicked');
                    addAdminModal.style.display = 'flex';
                });
            } else {
                console.error('Required elements not found:', { addAdminBtn, addAdminModal });
            }

            if (closeAddAdminModal || cancelAddAdmin) {
                [closeAddAdminModal, cancelAddAdmin].filter(btn => btn).forEach(btn => {
                    btn.addEventListener('click', () => {
                        addAdminModal.style.display = 'none';
                        document.getElementById('addAdminForm').reset();
                    });
                });
            }

            // Add admin form submission
            const addAdminForm = document.getElementById('addAdminForm');
            if (addAdminForm) {
                addAdminForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = {
                        username: document.getElementById('newAdminUsername').value,
                        displayName: document.getElementById('newAdminDisplayName').value,
                        password: document.getElementById('newAdminPassword').value,
                        role: document.getElementById('newAdminRole').value,
                        permissions: Array.from(document.querySelectorAll('.checkbox-group input[type="checkbox"]:checked')).map(cb => cb.value)
                    };

                    try {
                        await api.post('/admin/users', formData);
                        addAdminModal.style.display = 'none';
                        document.getElementById('addAdminForm').reset();
                        loadUsers(); // Reload users
                        alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    } catch (error) {
                        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                    }
                });
            }
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.logout();
            window.location.href = '../login.html';
        });

        // User menu dropdown
        document.getElementById('userMenu').addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const userMenu = document.getElementById('userMenu');
            const dropdown = document.getElementById('userDropdown');
            if (userMenu && dropdown && !userMenu.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Modal functionality
        const addAdminModal = document.getElementById('addAdminModal');
        const addAdminBtn = document.getElementById('addAdminBtn');
        const closeAddAdminModal = document.getElementById('closeAddAdminModal');
        const cancelAddAdmin = document.getElementById('cancelAddAdmin');

        addAdminBtn.addEventListener('click', () => {
            addAdminModal.style.display = 'flex';
        });

        [closeAddAdminModal, cancelAddAdmin].forEach(btn => {
            btn.addEventListener('click', () => {
                addAdminModal.style.display = 'none';
                document.getElementById('addAdminForm').reset();
            });
        });

        // Load users on page load
        document.addEventListener('DOMContentLoaded', loadUsers);

        async function loadUsers() {
            try {
                const users = await api.get('/admin/users');
                displayUsers(users);
                updateStats(users);
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('adminTableBody').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center error">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ</td>
                    </tr>
                `;
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('adminTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: var(--space-3);">
                            <div class="chat-avatar">üë§</div>
                            <div>
                                <div style="font-weight: 600;">${user.displayName || user.username}</div>
                                <div style="font-size: var(--font-size-sm); color: var(--text-secondary);">${user.email || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏µ‡πÄ‡∏°‡∏•'}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${getRoleBadgeClass(user.role)}">
                            ${getRoleText(user.role)}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${user.isActive ? 'badge-success' : 'badge-danger'}">
                            ${user.isActive ? '‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}
                        </span>
                    </td>
                    <td>
                        ${user.lastLogin ? new Date(user.lastLogin).toLocaleString('th-TH') : '‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢'}
                    </td>
                    <td>
                        <div style="display: flex; gap: var(--space-2);">
                            <button class="btn btn-ghost btn-sm" onclick="editUser('${user._id}')">‚úèÔ∏è</button>
                            ${user.username !== 'admin' ? `<button class="btn btn-ghost btn-sm" onclick="deleteUser('${user._id}')">üóëÔ∏è</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats(users) {
            document.getElementById('totalAdmins').textContent = users.length;
            document.getElementById('activeAdmins').textContent = users.filter(u => u.isActive).length;
            document.getElementById('superAdmins').textContent = users.filter(u => u.role === 'super_admin').length;
            document.getElementById('moderators').textContent = users.filter(u => u.role === 'moderator').length;
        }

        function getRoleBadgeClass(role) {
            switch (role) {
                case 'admin': return 'badge-danger';
                case 'agent': return 'badge-primary';
                case 'viewer': return 'badge-secondary';
                default: return 'badge-secondary';
            }
        }

        function getRoleText(role) {
            switch (role) {
                case 'admin': return '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö';
                case 'agent': return '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà';
                case 'viewer': return '‡∏ú‡∏π‡πâ‡∏î‡∏π';
                default: return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            }
        }

        // Edit and delete functions
        function editUser(userId) {
            const username = prompt('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:');
            const displayName = prompt('‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á:');
            const role = prompt('‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó (admin/agent/viewer):');
            
            if (username && displayName && role) {
                const updateData = {
                    username: username,
                    displayName: displayName,
                    role: role
                };
                
                api.put(`/admin/users/${userId}`, updateData)
                .then(() => {
                    alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    loadUsers(); // Reload list
                }).catch(error => {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                });
            }
        }

        function deleteUser(userId) {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ?')) {
                api.delete(`/admin/users/${userId}`)
                .then(() => {
                    alert('‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                    loadUsers(); // Reload list
                }).catch(error => {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                });
            }
        }

        // Search and filter functionality
        document.getElementById('searchAdmin').addEventListener('input', debounce(filterUsers, 300));
        document.getElementById('filterAdminRole').addEventListener('change', filterUsers);

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function filterUsers() {
            const searchTerm = document.getElementById('searchAdmin').value;
            const roleFilter = document.getElementById('filterAdminRole').value;

            try {
                const params = new URLSearchParams();
                if (searchTerm) params.append('search', searchTerm);
                if (roleFilter) params.append('role', roleFilter);

                const users = await api.get(`/admin/users?${params.toString()}`);
                displayUsers(users);
                updateStats(users);
            } catch (error) {
                console.error('Error filtering users:', error);
                document.getElementById('adminTableBody').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center error">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</td>
                    </tr>
                `;
            }
        }
    </script>

    <script src="../js/brand-animation.js"></script>
    <script src="../js/loading.js"></script>
    <script src="../js/keyboard-shortcuts.js"></script>
    <script src="../js/auto-save.js"></script>
    <script src="../js/breadcrumb.js"></script>
    <script src="../js/mobile.js"></script>
    <script src="../js/notifications.js"></script>
    <script src="../js/theme.js"></script>
    <script src="../js/admin-manager.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/user-display.js"></script>
    <script src="../js/global-user-menu.js"></script>
</body>
</html>