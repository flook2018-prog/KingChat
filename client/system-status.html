<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” System Status Check</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; }
        .status-item { 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 5px solid #6c757d;
        }
        .status-success { border-left-color: #28a745; background: #d4edda; }
        .status-error { border-left-color: #dc3545; background: #f8d7da; }
        .status-warning { border-left-color: #ffc107; background: #fff3cd; }
        .status-loading { border-left-color: #17a2b8; background: #d1ecf1; }
        button { 
            background: #007bff; 
            color: white; 
            padding: 12px 20px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .refresh-btn { background: #28a745; }
        .data-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        h1 { color: #333; text-align: center; }
        h2 { color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” KingChat System Status</h1>
        
        <div style="text-align: center; margin: 20px 0;">
            <button class="refresh-btn" onclick="checkAllStatus()">ğŸ”„ à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸£à¸°à¸šà¸šà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”</button>
        </div>

        <div id="status-results">
            <div class="status-item status-loading">
                <strong>ğŸ”„ à¸à¸³à¸¥à¸±à¸‡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸£à¸°à¸šà¸š...</strong>
            </div>
        </div>

        <h2>ğŸ“Š à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸£à¸°à¸šà¸š</h2>
        <div id="system-data" class="data-box">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...</div>

        <h2>ğŸš‘ à¸à¸²à¸£à¹à¸à¹‰à¹„à¸‚à¸”à¹ˆà¸§à¸™</h2>
        <div style="text-align: center;">
            <button onclick="quickFix()">ğŸ”§ à¹à¸à¹‰à¹„à¸‚à¸›à¸±à¸à¸«à¸² Login</button>
            <button onclick="testLoginDirect()">ğŸ”‘ à¸—à¸”à¸ªà¸­à¸š Login à¹‚à¸”à¸¢à¸•à¸£à¸‡</button>
            <button onclick="showPasswords()">ğŸ‘€ à¸”à¸¹à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™</button>
        </div>
        
        <div id="fix-results" class="data-box" style="display: none;"></div>
    </div>

    <script>
        const API_BASE = '/api';
        
        async function checkEndpoint(name, url, method = 'GET', body = null) {
            try {
                const options = {
                    method: method,
                    headers: { 'Content-Type': 'application/json' }
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                const response = await fetch(url, options);
                const data = await response.json();
                
                return {
                    name: name,
                    status: response.status,
                    ok: response.ok,
                    data: data,
                    url: url
                };
            } catch (error) {
                return {
                    name: name,
                    status: 'ERROR',
                    ok: false,
                    error: error.message,
                    url: url
                };
            }
        }

        async function checkAllStatus() {
            const resultsDiv = document.getElementById('status-results');
            const dataDiv = document.getElementById('system-data');
            
            resultsDiv.innerHTML = '<div class="status-item status-loading"><strong>ğŸ”„ à¸à¸³à¸¥à¸±à¸‡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š...</strong></div>';
            
            const checks = [
                { name: 'ğŸ¥ Health Check', url: '/health' },
                { name: 'ğŸ§ª API Test', url: `${API_BASE}/test` },
                { name: 'ğŸ—„ï¸ Database Init', url: `${API_BASE}/admin/init` },
                { name: 'ğŸ‘¥ Get Admins', url: `${API_BASE}/admin/admin-users` },
                { name: 'ğŸ” Login Test', url: `${API_BASE}/auth/login`, method: 'POST', body: { username: 'admin', password: 'admin123' } }
            ];
            
            let statusHTML = '';
            let systemInfo = '';
            
            for (const check of checks) {
                const result = await checkEndpoint(check.name, check.url, check.method, check.body);
                
                const statusClass = result.ok ? 'status-success' : 'status-error';
                const statusIcon = result.ok ? 'âœ…' : 'âŒ';
                
                statusHTML += `
                    <div class="status-item ${statusClass}">
                        <strong>${statusIcon} ${result.name}</strong><br>
                        URL: ${result.url}<br>
                        Status: ${result.status}<br>
                        ${result.error ? `Error: ${result.error}` : `Response: ${JSON.stringify(result.data).substring(0, 100)}...`}
                    </div>
                `;
                
                systemInfo += `=== ${result.name} ===\n`;
                systemInfo += `URL: ${result.url}\n`;
                systemInfo += `Status: ${result.status}\n`;
                systemInfo += `Result: ${JSON.stringify(result.data || result.error, null, 2)}\n\n`;
            }
            
            resultsDiv.innerHTML = statusHTML;
            dataDiv.textContent = systemInfo;
        }

        async function quickFix() {
            const resultsDiv = document.getElementById('fix-results');
            resultsDiv.style.display = 'block';
            resultsDiv.textContent = 'ğŸ”„ à¸à¸³à¸¥à¸±à¸‡à¹à¸à¹‰à¹„à¸‚...';
            
            try {
                // Try to create a working admin
                const response = await fetch(`${API_BASE}/admin/admin-users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'testuser',
                        displayName: 'Test User',
                        password: 'test123',
                        role: 'admin'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultsDiv.textContent = `âœ… à¸ªà¸£à¹‰à¸²à¸‡à¹à¸­à¸”à¸¡à¸´à¸™à¹ƒà¸«à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ!\nUsername: testuser\nPassword: test123\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    resultsDiv.textContent = `âŒ à¸ªà¸£à¹‰à¸²à¸‡à¹à¸­à¸”à¸¡à¸´à¸™à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ:\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultsDiv.textContent = `âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ${error.message}`;
            }
        }

        async function testLoginDirect() {
            const resultsDiv = document.getElementById('fix-results');
            resultsDiv.style.display = 'block';
            resultsDiv.textContent = 'ğŸ”„ à¸à¸³à¸¥à¸±à¸‡à¸—à¸”à¸ªà¸­à¸š login...';
            
            const testUsers = [
                { username: 'admin', password: 'admin123' },
                { username: 'aaa', password: 'aaa123' },
                { username: 'testuser', password: 'test123' }
            ];
            
            let results = 'à¸œà¸¥à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸š Login:\n\n';
            
            for (const user of testUsers) {
                try {
                    const response = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(user)
                    });
                    
                    const data = await response.json();
                    const status = response.ok ? 'âœ… à¸ªà¸³à¹€à¸£à¹‡à¸ˆ' : 'âŒ à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§';
                    
                    results += `${status} ${user.username}/${user.password}\n`;
                    results += `  Response: ${JSON.stringify(data).substring(0, 100)}...\n\n`;
                    
                } catch (error) {
                    results += `âŒ ${user.username}/${user.password} - Error: ${error.message}\n\n`;
                }
            }
            
            resultsDiv.textContent = results;
        }

        async function showPasswords() {
            const resultsDiv = document.getElementById('fix-results');
            resultsDiv.style.display = 'block';
            resultsDiv.textContent = 'ğŸ”„ à¸à¸³à¸¥à¸±à¸‡à¸”à¸¹à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™...';
            
            try {
                const response = await fetch(`${API_BASE}/admin/show-passwords`);
                const data = await response.json();
                
                if (response.ok && data.users) {
                    let passwordInfo = 'à¸£à¸²à¸¢à¸à¸²à¸£à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹ƒà¸™à¸£à¸°à¸šà¸š:\n\n';
                    
                    data.users.forEach(user => {
                        passwordInfo += `Username: ${user.username}\n`;
                        passwordInfo += `Display Name: ${user.displayName}\n`;
                        passwordInfo += `Active: ${user.isActive}\n`;
                        passwordInfo += `Password Hash: ${user.passwordHash.substring(0, 30)}...\n`;
                        passwordInfo += '---\n';
                    });
                    
                    resultsDiv.textContent = passwordInfo;
                } else {
                    resultsDiv.textContent = `âŒ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸”à¸¹à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹„à¸”à¹‰:\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultsDiv.textContent = `âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ${error.message}`;
            }
        }

        // Auto check on load
        window.onload = () => {
            checkAllStatus();
        };
    </script>
</body>
</html>