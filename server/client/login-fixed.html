<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîë Login - KingChat</title>
    <link rel="stylesheet" href="css/login.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .fallback-login {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            text-align: center;
        }
        .fallback-btn {
            background: #ffc107;
            color: #212529;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        .fallback-btn:hover {
            background: #e0a800;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <div class="brand">
                <div class="brand-icon">üëë</div>
                <h1>KingChat</h1>
                <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ LINE Official Account</p>
            </div>

            <div id="error-message" class="error-message"></div>

            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                    <input type="text" id="username" name="username" required>
                </div>
                
                <div class="form-group">
                    <label for="password">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="password" name="password" required>
                </div>
                
                <button type="submit" class="login-btn" id="loginButton">
                    <span id="loginText">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
                    <span id="loadingSpinner" class="loading-spinner" style="display: none;">‚è≥</span>
                </button>
            </form>

            <!-- Fallback Login Options -->
            <div class="fallback-login">
                <h4>üöë ‡∏Å‡∏£‡∏ì‡∏µ API ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô - ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£ Login ‡πÅ‡∏ö‡∏ö Offline</h4>
                <button class="fallback-btn" onclick="fallbackLogin('admin', 'admin123')">
                    Login ‡πÄ‡∏õ‡πá‡∏ô Admin
                </button>
                <button class="fallback-btn" onclick="fallbackLogin('aaa', 'aaa123')">
                    Login ‡πÄ‡∏õ‡πá‡∏ô AAA
                </button>
                <button class="fallback-btn" onclick="fallbackLogin('testuser', 'test123')">
                    Login ‡πÄ‡∏õ‡πá‡∏ô TestUser
                </button>
            </div>

            <div class="demo-account">
                <strong>Demo Account:</strong><br>
                Username: admin | Password: admin123
            </div>
        </div>
    </div>

    <script>
        // Fallback admin data (‡πÄ‡∏°‡∏∑‡πà‡∏≠ API ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô)
        const fallbackAdmins = [
            {
                id: 1,
                username: 'admin',
                password: 'admin123',
                displayName: 'System Administrator',
                email: 'admin@kingchat.com',
                role: 'admin'
            },
            {
                id: 2,
                username: 'aaa',
                password: 'aaa123',
                displayName: 'AAA User',
                email: 'aaa@kingchat.com',
                role: 'admin'
            },
            {
                id: 3,
                username: 'testuser',
                password: 'test123',
                displayName: 'Test User',
                email: 'testuser@kingchat.com',
                role: 'admin'
            }
        ];

        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('error-message');
            const loginButton = document.getElementById('loginButton');
            const loginText = document.getElementById('loginText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            // Show loading
            loginText.style.display = 'none';
            loadingSpinner.style.display = 'inline';
            loginButton.disabled = true;
            errorDiv.textContent = '';
            
            try {
                // Try API first
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success && data.token) {
                        // Store auth data
                        localStorage.setItem('authToken', data.token);
                        localStorage.setItem('currentUser', JSON.stringify(data.user));
                        
                        console.log('‚úÖ API Login successful');
                        window.location.href = '/dashboard.html';
                        return;
                    }
                }
                
                throw new Error('API Login failed');
                
            } catch (error) {
                console.log('‚ö†Ô∏è API failed, trying fallback login...');
                
                // Fallback to local authentication
                const user = fallbackAdmins.find(admin => 
                    admin.username === username && admin.password === password
                );
                
                if (user) {
                    // Create fake token and store user data
                    const fakeToken = btoa(JSON.stringify({
                        username: user.username,
                        timestamp: Date.now()
                    }));
                    
                    localStorage.setItem('authToken', fakeToken);
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    localStorage.setItem('loginMode', 'fallback');
                    
                    console.log('‚úÖ Fallback login successful');
                    window.location.href = '/dashboard.html';
                } else {
                    errorDiv.textContent = '‚ùå ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                    console.log('‚ùå Invalid credentials');
                }
            } finally {
                // Reset button
                loginText.style.display = 'inline';
                loadingSpinner.style.display = 'none';
                loginButton.disabled = false;
            }
        }

        function fallbackLogin(username, password) {
            document.getElementById('username').value = username;
            document.getElementById('password').value = password;
            
            const user = fallbackAdmins.find(admin => 
                admin.username === username && admin.password === password
            );
            
            if (user) {
                const fakeToken = btoa(JSON.stringify({
                    username: user.username,
                    timestamp: Date.now()
                }));
                
                localStorage.setItem('authToken', fakeToken);
                localStorage.setItem('currentUser', JSON.stringify(user));
                localStorage.setItem('loginMode', 'fallback');
                
                console.log(`‚úÖ Quick fallback login as ${username}`);
                alert(`‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞ ${user.displayName}`);
                window.location.href = '/dashboard.html';
            }
        }

        // Check if already logged in
        if (localStorage.getItem('authToken')) {
            console.log('‚ÑπÔ∏è Already logged in, redirecting...');
            window.location.href = '/dashboard.html';
        }
    </script>
</body>
</html>